<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EIRAE v3.0 - Dashboard (API-Ready)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .chart-container { height: 280px; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .leaflet-popup-content { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8"><div class="flex items-center justify-between h-16">
            <a href="#" class="text-2xl font-bold text-blue-600">EIRAE</a>
            <div class="hidden md:block"><div class="ml-10 flex items-baseline space-x-4">
                <a href="#dashboard" class="text-slate-600 hover:text-blue-500 px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                <a href="#mapa-riesgo" class="text-slate-600 hover:text-blue-500 px-3 py-2 rounded-md text-sm font-medium">Mapa de Riesgo</a>
            </div></div>
        </div></nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <section class="text-center pt-8 pb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-3"><span class="text-blue-600">Dashboard de Alerta Temprana</span></h1>
            <p class="text-lg text-slate-600 max-w-2xl mx-auto">Consumiendo datos en tiempo real desde la red de sensores Eirae.</p>
        </section>

        <section id="dashboard" class="mb-16">
            <div id="status-banner" class="flex items-center justify-center gap-4 p-4 rounded-lg mb-8 text-2xl font-semibold shadow-md text-center transition-all duration-500">
                <div id="generalRiskStatus">Cargando datos...</div>
            </div>
            <div class="mb-8"><div class="border-b border-slate-200"><nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button class="tab-button active text-blue-600 border-blue-600 py-4 px-1 border-b-2 font-medium text-sm" data-tab="metricas">Métricas Generales</button>
                <button class="tab-button text-slate-500 hover:text-slate-700 py-4 px-1 border-b-2 font-medium text-sm" data-tab="resumen">Resumen por Zonas</button>
                <button class="tab-button text-slate-500 hover:text-slate-700 py-4 px-1 border-b-2 font-medium text-sm" data-tab="log">Log de Eventos</button>
            </nav></div></div>
            <div id="tab-content">
                <div id="tab-metricas" class="tab-pane active"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartRiesgo"></canvas></div><div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartSintomas"></canvas></div><div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartAgua"></canvas></div><div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartTemp"></canvas></div><div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartHumedad"></canvas></div><div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartMosquitos"></canvas></div>
                </div></div>
                <div id="tab-resumen" class="tab-pane hidden"><div class="bg-white p-6 rounded-xl shadow-lg"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-500 uppercase bg-slate-50"><tr>
                    <th class="py-3 px-4">Zona</th><th class="py-3 px-4">Nivel Riesgo</th><th class="py-3 px-4">Riesgo (%)</th><th class="py-3 px-4">Síntomas</th><th class="py-3 px-4">Agua (mm)</th><th class="py-3 px-4">Temp (°C)</th>
                </tr></thead><tbody id="zones-table-body"></tbody></table></div></div></div>
                <div id="tab-log" class="tab-pane hidden"><div class="bg-white p-6 rounded-xl shadow-lg"><div id="event-log" class="space-y-3 text-sm h-96 overflow-y-auto pr-2"></div></div></div>
            </div>
        </section>

        <section id="mapa-riesgo" class="mb-16">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Mapa de Riesgo Zonal</h2>
            <div id="map" class="h-[500px] w-full rounded-xl shadow-lg z-10"></div>
        </section>
    </main>
    
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        
        // --- CONFIGURACIÓN INICIAL (GRÁFICOS, MAPA) ---
        Chart.defaults.font.family = "'Inter', sans-serif";
        const riskColors = { Bajo: '#22c55e', Moderado: '#f97316', Alto: '#ef4444' };
        
        const charts = {
            riesgo: createChart('chartRiesgo', 'Índice de Riesgo (%)', riskColors.Alto),
            sintomas: createChart('chartSintomas', 'Reportes de Síntomas', riskColors.Moderado),
            agua: createChart('chartAgua', 'Agua Estancada (mm)', '#3b82f6'),
            temp: createChart('chartTemp', 'Temperatura (°C)', '#eab308'),
            humedad: createChart('chartHumedad', 'Humedad (%)', '#22c55e'),
            mosquitos: createChart('chartMosquitos', 'Densidad Mosquitos', '#a855f7'),
        };
        const map = L.map('map').setView([-34.888, -58.384], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);
        let markers = {};

        // --- EL NUEVO MOTOR: FUNCIÓN PARA BUSCAR Y MOSTRAR DATOS ---
        async function fetchDataAndUpdate() {
            try {
                const response = await fetch('datos.json?t=' + new Date().getTime()); // El ?t=... evita que el navegador guarde en caché el archivo
                if (!response.ok) throw new Error('No se pudo cargar datos.json');
                const data = await response.json();

                // 1. Actualizar Banner Principal
                updateBanner(data.nivelAlertaGeneral);

                // 2. Actualizar Gráficos
                updateCharts(data.metricasGenerales);

                // 3. Actualizar Tabla de Zonas
                updateZonesTable(data.zonas);

                // 4. Actualizar Mapa
                updateMapMarkers(data.zonas);

                // 5. Actualizar Log de Eventos
                updateEventLog(data.logEventos);

            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('generalRiskStatus').textContent = "Error al cargar datos.";
            }
        }

        // --- FUNCIONES AUXILIARES PARA ACTUALIZAR LA UI ---
        function updateBanner(nivelAlerta) {
            const globalRiskDiv = document.getElementById('generalRiskStatus');
            const globalStatusDiv = document.getElementById('status-banner');
            const globalRiskColor = riskColors[nivelAlerta] || '#64748b';
            const bgColorClass = {Bajo: 'bg-green-100', Moderado: 'bg-yellow-100', Alto: 'bg-red-100'}[nivelAlerta] || 'bg-slate-100';
            
            globalRiskDiv.innerHTML = `Nivel de Alerta General: <span class="font-extrabold" style="color:${globalRiskColor};">${nivelAlerta}</span>`;
            globalStatusDiv.className = `flex items-center justify-center gap-4 p-4 rounded-lg mb-8 text-2xl font-semibold shadow-md text-center transition-all duration-500 ${bgColorClass}`;
        }

        function updateCharts(metricas) {
            const hora = new Date().toLocaleTimeString('es-AR');
            Object.keys(charts).forEach(key => {
                const chart = charts[key];
                if (chart.data.labels.length > 20) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
                chart.data.labels.push(hora);
                chart.data.datasets[0].data.push(metricas[key] || 0);
                chart.update('quiet');
            });
        }

        function updateZonesTable(zonas) {
            const tableBody = document.getElementById('zones-table-body');
            tableBody.innerHTML = '';
            zonas.forEach(zona => {
                const riskLevel = zona.riesgo >= 60 ? 'Alto' : zona.riesgo >= 30 ? 'Moderado' : 'Bajo';
                const row = `
                    <tr class="bg-white border-b hover:bg-slate-50">
                        <td class="py-3 px-4 font-medium text-slate-900">${zona.nombre}</td>
                        <td class="py-3 px-4"><span class="px-2 py-1 font-semibold text-xs rounded-full" style="background-color:${riskColors[riskLevel]}20; color:${riskColors[riskLevel]}">${riskLevel}</span></td>
                        <td class="py-3 px-4 font-semibold">${zona.riesgo}%</td>
                        <td class="py-3 px-4">${zona.sintomas}</td>
                        <td class="py-3 px-4">${zona.agua}</td>
                        <td class="py-3 px-4">${zona.temp}</td>
                    </tr>`;
                tableBody.innerHTML += row;
            });
        }
        
        function updateMapMarkers(zonas) {
             // Limpiar marcadores existentes para evitar duplicados
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};
            
            zonas.forEach(zona => {
                const riskLevel = zona.riesgo >= 60 ? 'Alto' : zona.riesgo >= 30 ? 'Moderado' : 'Bajo';
                const marker = L.circleMarker([zona.lat, zona.lon], { 
                    radius: 10, fillOpacity: 0.8, stroke: false, fillColor: riskColors[riskLevel]
                }).addTo(map);
                marker.bindPopup(`<b>${zona.nombre}</b><br>Riesgo: <b>${zona.riesgo}%</b> (${riskLevel})`);
                markers[zona.id] = marker;
            });
        }

        function updateEventLog(eventos) {
            const logContainer = document.getElementById('event-log');
            logContainer.innerHTML = '';
            eventos.forEach(evento => {
                const logEntry = `<p class="p-2 rounded-md bg-slate-50 text-${{Alto:'red',Moderado:'yellow',Bajo:'green'}[evento.nivel]}-600"><span class="font-semibold">[${evento.hora}]</span> ${evento.mensaje}</p>`;
                logContainer.innerHTML += logEntry;
            });
        }

        function createChart(id, label, color) { /* ... (código de la v2.7 sin cambios) ... */ }
        
        // Lógica de Pestañas (sin cambios)
        const tabs = document.querySelectorAll('.tab-button');
        tabs.forEach(tab => { tab.addEventListener('click', () => { /* ... (código sin cambios) ... */ }); });

        // --- EJECUCIÓN ---
        fetchDataAndUpdate(); // Primera llamada para cargar los datos iniciales
        setInterval(fetchDataAndUpdate, 3000); // Buscar nuevos datos cada 3 segundos
    });

    // FUNCIONES AUXILIARES (se pueden colapsar en el editor)
    function createChart(id, label, color) { const ctx = document.getElementById(id).getContext('2d'); return new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label, data: [], borderColor: color, backgroundColor: `${color}20`, borderWidth: 2.5, pointRadius: 0, tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { ticks: { display: false } } } } }); }
    document.querySelectorAll('.tab-button').forEach(tab => { tab.addEventListener('click', () => { const targetPane = document.getElementById(`tab-${tab.dataset.tab}`); document.querySelectorAll('.tab-button').forEach(t => { t.classList.remove('active', 'text-blue-600', 'border-blue-600'); t.classList.add('text-slate-500'); }); tab.classList.add('active', 'text-blue-600', 'border-blue-600'); tab.classList.remove('text-slate-500'); document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden')); targetPane.classList.remove('hidden'); }); });
    </script>
</body>
</html>
