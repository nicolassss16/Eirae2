<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EIRAE v2.7 - Dashboard Corregido</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { font-family: 'Inter', sans-serif; }
        .chart-container {
            height: 280px; /* Un poco más de altura para los gráficos */
        }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="#" class="text-2xl font-bold text-blue-600">EIRAE</a>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#dashboard" class="text-slate-600 hover:text-blue-500 px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                        <a href="#mapa-riesgo" class="text-slate-600 hover:text-blue-500 px-3 py-2 rounded-md text-sm font-medium">Mapa de Riesgo</a>
                        <a href="#solucion" class="text-slate-600 hover:text-blue-500 px-3 py-2 rounded-md text-sm font-medium">La Solución</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <section class="text-center pt-8 pb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-3">
                <span class="text-blue-600">Dashboard de Alerta Temprana</span>
            </h1>
            <p class="text-lg text-slate-600 max-w-2xl mx-auto">Análisis Predictivo para la Prevención del Dengue en Glew.</p>
        </section>

        <section id="dashboard" class="mb-16">
            <div id="status-banner" class="flex items-center justify-center gap-4 p-4 rounded-lg mb-8 text-2xl font-semibold shadow-md text-center transition-all duration-500">
                <div id="generalRiskStatus">Nivel de Alerta General: --</div>
            </div>

            <div class="mb-8">
                <div class="border-b border-slate-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button class="tab-button active text-blue-600 border-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="metricas">Métricas Generales</button>
                        <button class="tab-button text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="resumen">Resumen por Zonas</button>
                        <button class="tab-button text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="log">Log de Eventos</button>
                    </nav>
                </div>
            </div>

            <div id="tab-content">
                <div id="tab-metricas" class="tab-pane active"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartRiesgo"></canvas></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartSintomas"></canvas></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartAgua"></canvas></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartTemp"></canvas></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartHumedad"></canvas></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg chart-container"><canvas id="chartMosquitos"></canvas></div>
                </div></div>
                <div id="tab-resumen" class="tab-pane hidden"><div class="bg-white p-6 rounded-xl shadow-lg"><div class="overflow-x-auto"><table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50"><tr>
                        <th scope="col" class="py-3 px-4">Zona</th><th scope="col" class="py-3 px-4">Nivel Riesgo</th><th scope="col" class="py-3 px-4">Riesgo (%)</th><th scope="col" class="py-3 px-4">Síntomas</th><th scope="col" class="py-3 px-4">Agua (mm)</th><th scope="col" class="py-3 px-4">Temp (°C)</th>
                    </tr></thead><tbody id="zones-table-body"></tbody>
                </table></div></div></div>
                <div id="tab-log" class="tab-pane hidden"><div class="bg-white p-6 rounded-xl shadow-lg"><div id="event-log" class="space-y-3 text-sm h-96 overflow-y-auto pr-2"></div></div></div>
            </div>
        </section>

        <section id="mapa-riesgo" class="mb-16">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Mapa de Riesgo Zonal</h2>
            <p class="text-slate-500 mb-6">Estado en tiempo real de cada microzona. Haz clic en un punto para ver detalles.</p>
            <div id="map" class="h-[500px] w-full rounded-xl shadow-lg z-10"></div>
        </section>
        
    </main>
    
    <footer class="bg-slate-800 text-white mt-8">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-sm">
            <p>EIRAE - Prototipo Interactivo v2.7</p>
        </div>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- VARIABLES Y CONFIGURACIÓN INICIAL ---
        Chart.defaults.font.family = "'Inter', sans-serif";
        const zonas = [
            { id: 1, nombre: 'Plaza San Martin', lat: -34.891386, lon: -58.380, riesgoBase: 10, previousRiskLevel: 'Bajo', riesgoActual: 10, sintomas: 0 },
            { id: 2, nombre: 'B. Las Casitas', lat: -34.885, lon: -58.388, riesgoBase: 25, previousRiskLevel: 'Bajo', riesgoActual: 25, sintomas: 0 },
            { id: 3, nombre: 'Centro de Glew', lat: -34.888, lon: -58.384, riesgoBase: 15, previousRiskLevel: 'Bajo', riesgoActual: 15, sintomas: 0 },
            { id: 4, nombre: 'B. Villa Paris', lat: -34.882, lon: -58.378, riesgoBase: 40, previousRiskLevel: 'Moderado', riesgoActual: 40, sintomas: 0 }
        ];
        const riskColors = { Bajo: '#22c55e', Moderado: '#f97316', Alto: '#ef4444' };
        let activeEvent = { type: 'normal', triggered: false };

        // --- INICIALIZACIÓN DE COMPONENTES VISUALES ---
        const charts = {
            riesgo: createChart('chartRiesgo', 'Índice de Riesgo (%)', '#ef4444'),
            sintomas: createChart('chartSintomas', 'Reportes de Síntomas', '#f97316'),
            agua: createChart('chartAgua', 'Agua Estancada (mm)', '#3b82f6'),
            temp: createChart('chartTemp', 'Temperatura (°C)', '#eab308'),
            humedad: createChart('chartHumedad', 'Humedad (%)', '#22c55e'),
            mosquitos: createChart('chartMosquitos', 'Densidad Mosquitos', '#a855f7'),
        };
        const map = L.map('map').setView([-34.888, -58.384], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);
        const markers = {};
        zonas.forEach(zona => {
            markers[zona.id] = L.circleMarker([zona.lat, zona.lon], { radius: 10, fillOpacity: 0.8, stroke: false }).addTo(map);
        });
        const eventLog = document.getElementById('event-log');
        const zonesTableBody = document.getElementById('zones-table-body');

        // --- FUNCIONES AUXILIARES ---
        function createChart(id, label, color) {
            const ctx = document.getElementById(id).getContext('2d');
            return new Chart(ctx, {
                type: 'line', data: { labels: [], datasets: [{ 
                label, data: [], borderColor: color, backgroundColor: `${color}20`,
                borderWidth: 2.5, pointRadius: 0, tension: 0.4, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { ticks: { display: false } } } }
            });
        }
        function addEventToLog(message, level) {
            const time = new Date().toLocaleTimeString('es-AR');
            const logEntry = document.createElement('p');
            logEntry.className = `p-2 rounded-md bg-slate-50 text-${{Alto:'red',Moderado:'yellow',Bajo:'green'}[level]}-600`;
            logEntry.innerHTML = `<span class="font-semibold">[${time}]</span> ${message}`;
            eventLog.prepend(logEntry);
            if (eventLog.children.length > 10) { eventLog.lastChild.remove(); }
        }
        function updateZonesTable() {
            zonesTableBody.innerHTML = '';
            zonas.forEach(zona => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50';
                row.innerHTML = `
                    <td class="py-3 px-4 font-medium text-slate-900">${zona.nombre}</td>
                    <td class="py-3 px-4"><span class="px-2 py-1 font-semibold text-xs rounded-full" style="background-color:${riskColors[zona.riskLevel]}20; color:${riskColors[zona.riskLevel]}">${zona.riskLevel}</span></td>
                    <td class="py-3 px-4 font-semibold">${zona.riesgo}%</td>
                    <td class="py-3 px-4">${zona.sintomas}</td>
                    <td class="py-3 px-4">${zona.agua.toFixed(0)}</td>
                    <td class="py-3 px-4">${zona.temp}</td>`;
                zonesTableBody.appendChild(row);
            });
        }

        // --- MOTOR DE SIMULACIÓN Y CONTROL ---
        setInterval(updateSimulation, 2000);
        document.addEventListener('keydown', (e) => {
            if (['1', '2', '3', '4'].includes(e.key)) activeEvent = { type: e.key, triggered: true };
        });

        function updateSimulation() {
            if (activeEvent.triggered) {
                let logMessage = "Sistema volviendo a estado normal...";
                let logLevel = "Bajo";
                zonas.forEach(z => { z.riesgoActual = z.riesgoBase; z.sintomas = 0; });
                switch (activeEvent.type) {
                    case '2':
                        zonas[2].riesgoActual += 30; zonas[2].sintomas = 5;
                        logMessage = `<b>Reporte de Síntomas</b> inyectado en <b>Centro de Glew</b>.`; logLevel = 'Moderado';
                        break;
                    case '3':
                        zonas[1].riesgoActual += 40; zonas[1].sintomas = 3;
                        logMessage = `<b>Alerta Moderada</b> inyectada en <b>B. Las Casitas</b>.`; logLevel = 'Moderado';
                        break;
                    case '4':
                        zonas[3].riesgoActual += 60; zonas[3].sintomas = 8;
                        logMessage = `<b>ALERTA ALTA</b> inyectada en <b>B. Los Alamos</b>.`; logLevel = 'Alto';
                        break;
                }
                addEventToLog(logMessage, logLevel);
                activeEvent.triggered = false;
            }

            let totalRisk = 0;
            zonas.forEach(zona => {
                zona.riesgoActual += (zona.riesgoBase - zona.riesgoActual) * 0.1;
                const cycle = Math.sin(Date.now() / 60000 + zona.id);
                zona.riesgoActual += cycle * 5;
                zona.riesgo = Math.min(100, Math.max(0, zona.riesgoActual)).toFixed(0);
                zona.sintomas = Math.max(0, zona.sintomas + Math.round(cycle * 2)); // Síntomas también fluctúan un poco
                zona.agua = Math.max(0, zona.riesgo / 2 + cycle * 5);
                zona.temp = (24 + cycle * 4).toFixed(1);
                zona.humedad = (70 - cycle * 15).toFixed(1);
                zona.mosquitos = Math.max(0, zona.agua / 3 + cycle * 3);
                totalRisk += parseFloat(zona.riesgo);
                let riskLevel = 'Bajo';
                if (zona.riesgo >= 60) riskLevel = 'Alto'; else if (zona.riesgo >= 30) riskLevel = 'Moderado';
                if (riskLevel !== zona.previousRiskLevel) {
                    addEventToLog(`Riesgo en <b>${zona.nombre}</b> cambió a <b>${riskLevel}</b>.`, riskLevel);
                    zona.previousRiskLevel = riskLevel;
                }
                zona.riskLevel = riskLevel;
                markers[zona.id].setStyle({ fillColor: riskColors[riskLevel] });
                markers[zona.id].bindPopup(`<b>${zona.nombre}</b><br>Riesgo: <b>${zona.riesgo}%</b> (${riskLevel})`);
            });
            
            updateAllVisuals(totalRisk);
        }

        function updateAllVisuals(totalRisk) {
            const avgRisk = totalRisk / zonas.length;
            const avgData = {
                riesgo: avgRisk,
                sintomas: zonas.reduce((a, b) => a + b.sintomas, 0) / zonas.length, // <<<--- AQUÍ ESTABA EL ERROR, AHORA CORREGIDO
                agua: zonas.reduce((a, b) => a + b.agua, 0) / zonas.length,
                temp: zonas.reduce((a, b) => a + parseFloat(b.temp), 0) / zonas.length,
                humedad: zonas.reduce((a, b) => a + parseFloat(b.humedad), 0) / zonas.length,
                mosquitos: zonas.reduce((a, b) => a + b.mosquitos, 0) / zonas.length,
            };
            const hora = new Date().toLocaleTimeString('es-AR');
            Object.keys(charts).forEach(key => {
                const chart = charts[key];
                if (chart.data.labels.length > 20) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
                chart.data.labels.push(hora);
                chart.data.datasets[0].data.push(avgData[key].toFixed(1));
                chart.update('quiet');
            });
            
            updateZonesTable();
            
            const globalStatusDiv = document.getElementById('status-banner');
            const globalRiskDiv = document.getElementById('generalRiskStatus');
            let globalRiskLevel = 'Bajo';
            if (avgRisk >= 60) globalRiskLevel = 'ALERTA'; else if (avgRisk >= 30) globalRiskLevel = 'Moderado';
            const globalRiskColor = riskColors[globalRiskLevel === 'ALERTA' ? 'Alto' : globalRiskLevel];
            globalRiskDiv.innerHTML = `Nivel de Alerta General: <span class="font-extrabold" style="color:${globalRiskColor};">${globalRiskLevel}</span>`;
            const bgColorClass = {Bajo: 'bg-green-100', Moderado: 'bg-yellow-100', ALERTA: 'bg-red-100'}[globalRiskLevel];
            globalStatusDiv.className = `flex items-center justify-center gap-4 p-4 rounded-lg mb-8 text-2xl font-semibold shadow-md text-center transition-all duration-500 ${bgColorClass}`;
        }
        
        // LÓGICA DE PESTAÑAS
        const tabs = document.querySelectorAll('.tab-button');
        const panes = document.querySelectorAll('.tab-pane');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetPane = document.getElementById(`tab-${tab.dataset.tab}`);
                tabs.forEach(t => {
                    t.classList.remove('active', 'text-blue-600', 'border-blue-600');
                    t.classList.add('text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');
                });
                tab.classList.add('active', 'text-blue-600', 'border-blue-600');
                tabs.forEach(p => panes[Array.from(tabs).indexOf(p)].classList.add('hidden'));
                targetPane.classList.remove('hidden');
            });
        });
        
        updateSimulation(); // Primera llamada para que la página no inicie vacía
    });
    </script>
</body>
</html>
